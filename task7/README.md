# Task 7 - Privilege Escalation

<div align="center">
<img src="https://img.shields.io/badge/categories-Web%20Hacking%2C%20%5Bredacted%5D-informational">
<img src="https://img.shields.io/badge/points-300-success">
<img src="https://img.shields.io/badge/tools-Python-blueviolet">
</div>

> With access to the site, you can access most of the functionality. But there's still that admin area that's locked off.
>
> Generate a new token value which will allow you to access the ransomware site *as an administrator.*
>
> Prompt:
>
> - Enter a token value which will allow you to login as an administrator.

## Solution

Obviously we have access to the main ransomware-as-a-service website at this point, where to go from here wasn't super obvious to me initially (or anyone I would think haha) so I decided to poke around to see what I could do.

### Exploration

The home page we saw at the end of task 6 isn't too remarkable:

<div align="center">
<img src="../task6/img/website%20homepage.png">
</div>

Hopefully that key database rollback won't affect us (hint: foreshadowing :)). Other than that, though, we don't really get much information. Onto the next page, "Generate Key":

<div align="center">
<img src="img/generatekey.png">
</div>

Man, the attacker didn't leave any credit for us? I guess we can't really do much with this page either. Onto "Unlock Request" I guess:

<div align="center">
<img src="img/unlockreq.png">
</div>

It wants a receipt? Not really sure where we'd get that. Next!

<div align="center">
<img src="img/adminlist.png">
</div>

Now this looks interesting. Looks like the only admin left is NervousHiccups, so I assume that's who we're gonna have to impersonate. I can't help but feel bad for the other admins though, especially evil rock :(

Onto "User Info:"

<div align="center">
<img src="img/userinfo.png">
</div>

That's a username and a half :) Seems like our attacker was pretty helpful on this website. This page seems interesting though since all of the information displayed on it is probably loaded from a database somewhere. Maybe this will be how we get an admin token? I'll look at the other two pages before trying anything though :)

<div align="center">
<img src="img/forum.png">
</div>

The home page mentioned the forum page was down, and I can't click on any of the pages so this is pretty useless. The admin page looks interesting though:

<div align="center">
<img src="img/admin-warning.png">
</div>

Or not, hopefully nothing bad will come from the logging of this attempt D:

### Backend review (TODO?)

I figured I'd take a look at the [website source from B2](../task-B2/server-files/app/server.py) again to check if there was anything interesting, and boy wasn't I disappointed:

```python
def userinfo():
    """ Create a page that displays information about a user """
    query = request.values.get('user')
    if query == None:
        query =  util.get_username()
    userName = memberSince = clientsHelped = hackersHelped = contributed = ''
    with util.userdb() as con:
        infoquery= "SELECT u.memberSince, u.clientsHelped, u.hackersHelped, u.programsContributed FROM Accounts a INNER JOIN UserInfo u ON a.uid = u.uid WHERE a.userName='%s'" %query
        row = con.execute(infoquery).fetchone()
        if row != None:
            userName = query
            memberSince = int(row[0])
            clientsHelped = int(row[1])
            hackersHelped = int(row[2])
            contributed = int(row[3])
  # --snip--
```

So apparently there's a query argument for getting information about a specific user, but more interestingly, that username is directly interpolated into the database request without escaping or anything which allows us to perform SQL injection :) Now it's only a matter of crafting the right query to give us NervousHiccups' secret and user id.

### Querycrafting

Let's review how the login tokens are generated by the server:

```python
# app/util.py - lines 59-69
def generate_token(userName):
    """ Generate a new login token for the given user, good for 30 days"""
    with userdb() as con:
        row = con.execute("SELECT uid, secret from Accounts WHERE userName = ?", (userName,)).fetchone()
        now = datetime.now()
        exp = now + timedelta(days=30)
        claims = {'iat': now,
                  'exp': exp,
                  'uid': row[0],
                  'sec': row[1]}
        return jwt.encode(claims, hmac_key(), algorithm='HS256')
```

So we know that the userid (`uid`) and secret (`sec`) are located within the Accounts table in the user database. We also know that the sqlite query parameter system is used properly here (based on the `username = ?`), which is weird since it's inconsistent but ultimately irrelevant :) In this case, [SQL's `UNION` operator](https://www.sqlite.org/lang_select.html#compound) will be our friend in selecting from tables that we shouldn't be able to.

# TODO: Explain structure of website w/ solve script

- explore website pages
  - home: data loss huh?
  - generateKey: no creds :(
  - unlock: invalid receipt huh?
  - admin list: nervoushiccups? ðŸ‘€
  - userinfo: X-RatedSnowboarding lmao
  - forum: nothing :(
  - admin: ono attempt logged (yeah but who asked?)
    - also what logging? :P
- Already had suspicion for sql injection
- aha! userinfo page!
- int cast ðŸ’€
  - uid is easy
  - ascii codepoints maybe? (ackshoeally it's [`unicode()`](https://www.sqlite.org/lang_corefunc.html#unicode) + `substr()`)
    - 32 requests ðŸ’€ (honestly didn't really care for golfing it into single request)
    - cyberchef ftw
      - python >>>>>>>>> tho
  - oh yeah it's sqlite btw
- PyJWT is really helpful :)
- same process as task 6 to log in (setting cookie; honestly just modify value)
